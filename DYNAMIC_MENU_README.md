# Dynamic Menu System - Динамическая система меню

## 📊 Обзор

Полная переработка Telegram бота с динамической системой главного меню, фильтров и категорий.

### Ключевые особенности:

✅ **Главное меню из БД** - TALIM, DOSTAVKA и другие пункты загружаются из базы данных  
✅ **Динамические фильтры** - Администратор может добавлять фильтры БЕЗ КОДА  
✅ **Иерархия категорий** - 3+ уровней вложенности  
✅ **ONE MESSAGE навигация** - Все переходы в одном сообщении (без спама)  
✅ **Расширяемость** - Админ управляет всем через бота  

## 🗄️ Структура БД

### MainMenu
```python
# Пункты главного меню (TALIM, DOSTAVKA)
- name_ru, name_uz: Название
- icon: Иконка (📚, 🚚)
- order_index: Порядок отображения
- is_active: Включено/выключено
```

### MenuFilter
```python
# Фильтры для меню (Гражданство, Вид документа)
- main_menu_id: Ссылка на главное меню
- name_ru, name_uz: Название фильтра
- filter_type: Тип (buttons)
- order_index: Порядок
```

### MenuFilterOption
```python
# Опции фильтра (Узбекистан, Россия, Казахстан)
- filter_id: Ссылка на фильтр
- name_ru, name_uz: Название опции
- icon: Иконка (🇺🇿, 🇷🇺)
- order_index: Порядок
```

### Category
```python
# Категории с иерархией
- main_menu_id: Ссылка на главное меню
- parent_category_id: Родительская категория (для вложенности)
- filter_option_id: Привязка к фильтру (опционально)
- name_ru, name_uz: Название
- icon: Иконка
```

### CategoryContent
```python
# Контент категории
- category_id: Ссылка на категорию
- content_type: text|photo|pdf|audio|location
- text_ru, text_uz: Текст
- file_id: Telegram file_id
- latitude, longitude: Координаты (для location)
- location_title_ru, location_title_uz: Название локации
```

### CategoryButton
```python
# Кнопки категории
- category_id: Ссылка на категорию
- text_ru, text_uz: Текст кнопки
- button_type: url|next_category
- action_data: JSON с данными действия
  - {"url": "https://..."} для url
  - {"category_id": 5} для next_category
```

## 🚀 Инициализация

```bash
# 1. Применить миграции (если используете Alembic)
python3 -m alembic upgrade head

# 2. Инициализировать данные
python3 init_dynamic_menu.py
```

Это создаст:
- **TALIM** меню с фильтром "Гражданство" (Узбекистан, Россия, Казахстан)
- **DOSTAVKA** меню

## 👤 User Bot - Использование

### Навигация (ONE MESSAGE)

1. **Пользователь нажимает кнопку "📚 TALIM"**
   - Отправляется ОДНО сообщение с фильтрами и категориями

2. **Пользователь выбирает фильтр "🇺🇿 Узбекистан"**
   - ТО ЖЕ сообщение обновляется
   - Показываются категории для Узбекистана

3. **Пользователь выбирает категорию "📖 Учебники"**
   - ТО ЖЕ сообщение обновляется
   - Показывается контент (текст, фото, PDF, аудио, локация, кнопки)

4. **Пользователь нажимает "🔙 Назад"**
   - ТО ЖЕ сообщение обновляется
   - Возврат на предыдущий уровень

### Пример flow:

```
┌─────────────────────────────────┐
│ 📚 TALIM                        │
│                                 │
│ 🔍 ФИЛЬТРЫ:                     │
│ [🇺🇿 Узбекистан] [🇷🇺 Россия]   │
│                                 │
│ 📚 КАТЕГОРИИ:                   │
│ [📖 Учебники] [📚 Справочники]  │
│                                 │
│ [🔙 Главное меню]               │
└─────────────────────────────────┘
        ↓ (выбор фильтра)
┌─────────────────────────────────┐
│ 📚 TALIM → 🇺🇿 Узбекистан       │
│                                 │
│ 📚 КАТЕГОРИИ:                   │
│ [📖 Учебники] [📚 Справочники]  │
│                                 │
│ [🔙 Главное меню]               │
└─────────────────────────────────┘
        ↓ (выбор категории)
┌─────────────────────────────────┐
│ 📚 TALIM → 🇺🇿 → 📖 Учебники    │
│                                 │
│ 📄 СОДЕРЖИМОЕ:                  │
│ ✅ Математика (PDF: 5.2 MB)     │
│ ✅ История (PDF: 3.8 MB)        │
│                                 │
│ 🌐 ССЫЛКИ:                      │
│ [Официальный сайт]              │
│                                 │
│ [🔙 Назад]                      │
└─────────────────────────────────┘
```

## 👨‍💼 Admin Bot - Управление

### Управление главным меню

```
/admin → Управление → Dynamic Menu

┌─────────────────────────────────┐
│ 🔧 УПРАВЛЕНИЕ ГЛАВНЫМ МЕНЮ      │
│                                 │
│ ✅ 📚 TALIM [✏️] [🗑️]           │
│ ✅ 🚚 DOSTAVKA [✏️] [🗑️]        │
│                                 │
│ [➕ Добавить меню]              │
│ [🔙 Назад]                      │
└─────────────────────────────────┘
```

### Редактирование меню

```
┌─────────────────────────────────┐
│ ✏️ РЕДАКТИРОВАНИЕ: TALIM        │
│                                 │
│ 📝 NAME (RU): TALIM             │
│ 📝 NAME (UZ): Ta'lim            │
│ 🔄 STATUS: ✅ ON                │
│                                 │
│ 🔍 ФИЛЬТРЫ:                     │
│   • Гражданство (3 опций)       │
│                                 │
│ 📚 КАТЕГОРИИ:                   │
│   • 📖 Учебники                 │
│   • 📚 Справочники              │
│                                 │
│ [✏️ Изменить имя (RU)]          │
│ [✏️ Изменить имя (UZ)]          │
│ [🔄 Toggle]                     │
│ [➕ Добавить фильтр]            │
│ [➕ Добавить категорию]         │
│ [🔙 Назад]                      │
└─────────────────────────────────┘
```

### Добавление фильтра

```
Шаг 1/3: Введите имя фильтра (RU)
→ Администратор вводит: "Гражданство"

Шаг 2/3: Введите имя фильтра (UZ)
→ Администратор вводит: "Fuqarolik"

Шаг 3/3: Введите варианты через запятую (RU|UZ)
→ Администратор вводит: "Узбекистан|O'zbekiston, Россия|Rossiya"

✅ Фильтр создан!
```

### Добавление категории

```
[➕ Добавить категорию]
→ Выбрать меню: TALIM
→ Ввести название (RU): Учебники
→ Ввести название (UZ): Darsliklar
→ Выбрать иконку: 📖

✅ Категория создана!
```

### Добавление контента

```
Редактирование категории: Учебники

[➕ Добавить контент]
→ Выбрать тип: TEXT
→ Ввести текст (RU): "Здесь вы найдете учебники..."
→ Ввести текст (UZ): "Bu yerda darsliklarni topasiz..."

✅ Контент добавлен!
```

## 📦 Файлы проекта

### Новые файлы:

```
models.py                              # ✅ Обновлено (MainMenu, MenuFilter, etc.)
services/dynamic_menu_service.py       # ✅ Создано
bots/handlers/user_navigation_handlers.py   # ✅ Создано
bots/handlers/admin_dynamic_menu_handlers.py # ✅ Создано
init_dynamic_menu.py                   # ✅ Создано
states.py                              # ✅ Обновлено (adding_filter_*)
```

### Обновленные файлы:

```
services/category_service.py           # ✅ Обновлено (убрали key, добавили get_categories_by_menu)
```

## 🔌 Подключение хендлеров

### User Bot (bots/user_bot.py)

```python
from bots.handlers import user_navigation_handlers

# Регистрация роутеров
dp.include_router(user_navigation_handlers.router)
```

### Admin Bot (bots/admin_bot.py)

```python
from bots.handlers import admin_dynamic_menu_handlers

# Регистрация роутеров
dp.include_router(admin_dynamic_menu_handlers.router)
```

## 🎯 Преимущества новой системы

✅ **Без хардкода** - Все данные в БД  
✅ **Расширяемость** - Админ добавляет что угодно  
✅ **ONE MESSAGE** - Нет спама сообщений  
✅ **Иерархия** - Неограниченная вложенность  
✅ **Фильтры** - Динамические фильтры для категорий  
✅ **Контент** - Текст, фото, PDF, аудио, локация, кнопки  
✅ **Удобство** - Все управление через бота  

## 📝 TODO

- [ ] Создать Alembic миграцию для новых таблиц
- [ ] Обновить тесты
- [ ] Добавить админский роутер в admin_bot.py
- [ ] Добавить user роутер в user_bot.py
- [ ] Переписать delivery form (ONE MESSAGE)
- [ ] Добавить courier notifications
- [ ] Обновить документацию

## 🐛 Troubleshooting

### Ошибка: "category.key not found"

**Решение**: Обновите CategoryService, используйте `get_categories_by_menu()` вместо `get_category_by_key()`

### Ошибка: "MainMenu table not found"

**Решение**: Выполните миграцию или создайте таблицы вручную

```sql
CREATE TABLE main_menu (...);
CREATE TABLE menu_filters (...);
CREATE TABLE menu_filter_options (...);
CREATE TABLE category_content (...);
```

### Ошибка: "message is not modified"

**Решение**: Это нормально, обрабатывается в коде:

```python
try:
    await callback.message.edit_text(text, reply_markup=markup)
except TelegramBadRequest as e:
    if "message is not modified" not in str(e).lower():
        raise
```

## 📞 Поддержка

При возникновении проблем:
1. Проверьте логи: `utils.logger`
2. Проверьте состояния: `AdminStates`, `UserStates`
3. Проверьте БД: таблицы созданы?
4. Проверьте init скрипт: данные загружены?

## 🎉 Готово!

Теперь ваш бот поддерживает полную динамическую систему меню с фильтрами и категориями!
